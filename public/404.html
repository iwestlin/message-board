<!DOCTYPE html>
<html>

<head>
  <title>Talk to Wallace</title>
  <meta charset="utf-8">
  <base target="_blank" />
  <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
  <link rel="stylesheet" href="github-markdown.css">
  <link rel="stylesheet" href="main.css">
  <style type="text/css">
  .infinite-scroll-signal {
    width: 0;
    height: 0;
    visibility: hidden;
  }
  </style>
</head>

<body>
  <div id="container"></div>
  <div class="infinite-scroll-signal"></div>
  <script src="markdown-it.min.js"></script>
  <script src="axios.min.js"></script>
  <script src="utils.js"></script>
  <script>
  let isLoading = false
  let sum = 0
  let pageIndex = 1
  const limit = 50
  const md = window.markdownit()
  const link = `https://dataservice.viegg.com/talk?limit=${limit}&page=`
  const signal = document.querySelector('.infinite-scroll-signal')
  displayPosts()
  window.addEventListener('scroll', utils.throttle(loadPosts, 200))
  // reverseChildNodes(document.getElementById('container'))

  function shouldLoad () {
    if (isLoading || (Math.ceil(sum / limit) <= pageIndex)) {
      return false
    } else {
      const rect = signal.getBoundingClientRect()
      if (rect.bottom <= document.documentElement.clientHeight * 2) {
        return true
      }
    }
  }

  function loadPosts () {
    if (shouldLoad()) {
      isLoading = true
      axios.get(link + (pageIndex + 1)).then(data => {
        appendPosts(data.data)
        isLoading = false
        pageIndex += 1
      })
    }
  }

  function appendPosts (posts) {
    var container = document.getElementById('container')
    var fragment = document.createDocumentFragment()
    posts.forEach(post => {
      fragment.appendChild(createFieldset(post))
    })
    container.appendChild(fragment)
  }

  function displayPosts() {
    axios.get(link).then(res => {
      var posts = objToArray(res.data)
      if (posts.length) {
        sum = posts[0].id
        appendPosts(posts)
      }
    }).catch(err => {
      console.log(err)
      alert('服务器无响应')
    })
  }

  function reverseChildNodes (node) {
    var frag = node.ownerDocument.createDocumentFragment()
    while (node.lastChild) {
      frag.appendChild(node.lastChild)
    }
    node.appendChild(frag)
  }

  function createFieldset(post) {
    var id = post.id
    var lgdom = document.createElement('legend')
    lgdom.innerText = '#' + id + ' | ' + timestampToLocalTime(post.date)
    var p = document.createElement('p')
    p.innerHTML = md.render(post.message)
    var fsdom = document.createElement('fieldset')
    fsdom.id = String(id)
    fsdom.appendChild(lgdom)
    fsdom.appendChild(p)
    return fsdom
  }

  function timestampToLocalTime(n) {
    n = parseInt(n) || 0
    var d = new Date(n)
    return d.toLocaleDateString() + ' ' + d.toTimeString().split(' ')[0]
  }

  function objToArray(o) {
    return Object.keys(o || {}).map(key => o[key])
  }
  </script>
</body>

</html>
