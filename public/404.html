<!DOCTYPE html>
<html>

<head>
  <title>Talk to Wallace</title>
  <meta charset="utf-8">
  <base target="_blank" />
  <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
  <link rel="stylesheet" href="github-markdown.css">
  <link rel="stylesheet" href="main.css">
</head>

<body>
  <div id="container"></div>
  <script src="markdown-it.min.js"></script>
  <script src="axios.min.js"></script>
  <script>
  const md = window.markdownit()
  const link = 'http://172.96.215.29:3333/talk'
  displayPosts()

  function displayPosts() {
    var div = document.getElementById('container')
    var fragment = document.createDocumentFragment()
    axios.get(link).then(res => {
      div.innerHTML = ''
      var posts = res.data
      posts = objToArray(posts)
      posts.sort((x, y) => Number(y.date) - Number(x.date))
      posts.forEach((post, index) => {
        fragment.appendChild(createFieldset(post, posts.length - index))
      })
      div.appendChild(fragment)
    })
  }

  function createFieldset(post, id) {
    var lgdom = document.createElement('legend')
    lgdom.innerText = '#' + id + ' | ' + timestampToLocalTime(post.date)
    var p = document.createElement('p')
    p.innerHTML = md.render(post.message)
    var fsdom = document.createElement('fieldset')
    fsdom.id = String(id)
    fsdom.appendChild(lgdom)
    fsdom.appendChild(p)
    return fsdom
  }

  function timestampToLocalTime(n) {
    n = parseInt(n) || 0
    var d = new Date(n)
    return d.toLocaleDateString() + ' ' + d.toTimeString().split(' ')[0]
  }

  function objToArray(o) {
    return Object.keys(o || {}).map(key => o[key])
  }
  </script>
</body>

</html>